Version 1
SubGoalCombiner SGC_AND
INITSECTION
LLINNATE_InitSettings();
KBSECTION
//REGION TALENT_ADDING_PROCS
PROC
LLINNATE_MakePlayer((CHARACTERGUID)_Player)
AND
CharacterIsPlayer(_Player, 0)
AND
CharacterGetHostCharacter(_Player)
THEN
ObjectSetFlag(_Player, "LLINNATE_RevertToNPC");
CharacterMakePlayer(_Player);

PROC
LLINNATE_AddInnateTalents((CHARACTERGUID)_Player)
AND
CharacterIsSummon(_Player, 0)
AND
CharacterIsPartyFollower(_Player, 0)
AND
ObjectGetFlag(_Player, "LLINNATE_RefundedTalentPoints", 0)
AND
CharacterHasTalent(_Player, "QuickStep", _Refund1)
AND
CharacterHasTalent(_Player, "ViolentMagic", _Refund2)
AND
CharacterHasTalent(_Player, "AnimalEmpathy", _Refund3)
AND
IntegerSum(_Refund1, _Refund2, _RefundCombo1)
AND
IntegerSum(_RefundCombo1, _Refund3, _RefundTalentPoints)
AND
_RefundTalentPoints > 0
AND
IntegertoString(_RefundTalentPoints, _RefundPointsStr)
AND
StringConcatenate("<font color='#00FF00'>Refunded ", _RefundPointsStr, _Str1)
AND
StringConcatenate(_Str1, " Talent Points</font>", _Message)
THEN
CharacterAddTalentPoint(_Player, _RefundTalentPoints);
ObjectSetFlag(_Player, "LLINNATE_RefundedTalentPoints");
ShowNotification(_Player, _Message);

PROC
LLINNATE_AddInnateTalents((CHARACTERGUID)_Player)
AND
ObjectGetFlag(_Player, "LLINNATE_RefundedTalentPoints", 0)
THEN
ObjectSetFlag(_Player, "LLINNATE_RefundedTalentPoints");

PROC
LLINNATE_AddInnateTalents((CHARACTERGUID)_Player)
THEN
CharacterAddTalent(_Player, "QuickStep");
CharacterAddTalent(_Player, "ViolentMagic");
CharacterAddTalent(_Player, "AnimalEmpathy");

PROC
LLINNATE_AddInnateTalents((CHARACTERGUID)_Player)
AND
CharacterIsSummon(_Player, 0)
AND
CharacterIsPartyFollower(_Player, 0)
AND
CharacterIsControlled(_Player, 1)
THEN
ShowNotification(_Player, "LLINNATE_InnateTalentsAdded");

PROC
LLINNATE_AddInnateTalents((CHARACTERGUID)_Player)
AND
ObjectGetFlag(_Player, "LLINNATE_RevertToNPC", 1)
THEN
ObjectClearFlag(_Player, "LLINNATE_RevertToNPC");
CharacterMakeNPC(_Player);
//END_REGION

//REGION ADD_TALENTS
IF
GameStarted(_Region, _)
AND
NOT DB_GlobalFlag("LLINNATE_TalentsInitialized")
AND
IsGameLevel(_Region, 1)
THEN
TimerCancel("LLINNATE_Timers_AddTalents");
TimerLaunch("LLINNATE_Timers_AddTalents", 1000);

IF
TimerFinished("LLINNATE_Timers_AddTalents")
THEN
GlobalSetFlag("LLINNATE_TalentsInitialized");

IF
TimerFinished("LLINNATE_Timers_AddTalents")
AND
DB_IsPlayer(_Player)
AND
ObjectGetFlag(_Player, "LLINNATE_AddedTalents", 0)
THEN
ObjectSetFlag(_Player, "LLINNATE_AddedTalents");
LLINNATE_AddInnateTalents(_Player);

IF
GlobalFlagSet("LLINNATE_Commands_ResetAndAddTalents")
AND
CharacterGetHostCharacter(_Host)
THEN
GlobalClearFlag("LLINNATE_Commands_ResetAndAddTalents");
PartyClearFlag(_Host, "LLINNATE_AddedTalents", 0);
GlobalSetFlag("LLINNATE_RestartInitialization");
/*
IF
TimerFinished("LLINNATE_Timers_AddTalents")
AND
DB_Origins(_Player)
AND
ObjectExists(_Player, 1)
AND
CharacterIsPlayer(_Player, 0)
AND
ObjectGetFlag(_Player, "LLINNATE_AddedTalents", 0)
THEN
ObjectSetFlag(_Player, "LLINNATE_AddedTalents");
LLINNATE_MakePlayer(_Player); // NPCs can't get talents
LLINNATE_AddInnateTalents(_Player);
*/
//END_REGION

//REGION ADD_EVENTS
IF
CharacterJoinedParty(_Player)
AND
DB_CurrentLevel(_Region)
AND
IsGameLevel(_Region, 1)
AND
DB_GlobalFlag("LLINNATE_TalentsInitialized")
AND
ObjectGetFlag(_Player, "LLINNATE_AddedTalents", 0)
THEN
ObjectSetFlag(_Player, "LLINNATE_AddedTalents");
LLINNATE_AddInnateTalents(_Player);

IF
GlobalFlagSet("LLINNATE_RestartInitialization")
THEN
TimerCancel("LLINNATE_Timers_AddTalents");
TimerLaunch("LLINNATE_Timers_AddTalents", 250);
GlobalClearFlag("LLINNATE_RestartInitialization");
//END_REGION

//REGION SKILL_REPLACERS
PROC
LLINNATE_InitSettings()
THEN
DB_LLINNATE_Skills_Race("REALLY_DWARF", "Target_PetrifyingTouch");
DB_LLINNATE_Skills_Race("REALLY_ELF", "Shout_FleshSacrifice");
DB_LLINNATE_Skills_Race("REALLY_HUMAN", "Shout_InspireStart");
DB_LLINNATE_Skills_Race("REALLY_LIZARD", "Cone_Flamebreath");

DB_LLINNATE_Skills_Origins("IFAN", "Summon_SoulWolf");
DB_LLINNATE_Skills_Origins("RED_PRINCE", "Target_DemonicStare");
DB_LLINNATE_Skills_Origins("SEBILLE", "Shout_BreakTheShackles");
DB_LLINNATE_Skills_Origins("BEAST", "Target_Squall");
DB_LLINNATE_Skills_Origins("LOHSE", "Target_MaddeningSong");
DB_LLINNATE_Skills_Origins("FANE", "Target_TimeWarp");
DB_LLINNATE_Skills_Origins("GENERIC", "Dome_CircleOfProtection");

//Flag, Racial Skill Replacer, Origin Skill Replacer
DB_LLINNATE_Skills_Replacers("LLINNATE_SkillReplacer_Necromancer", "Shout_FleshSacrifice", "Storm_LLINNATE_DeathStorm");
DB_LLINNATE_Skills_Replacers("LLINNATE_SkillReplacer_Elf", "Shout_FleshSacrifice", "");

PROC
LLINNATE_Updater_VersionUpdated((STRING)_OldVersion, "1.0.1.0")
THEN
LLINNATE_InitSettings();

IF
ObjectFlagSet(_ReplacerFlag, (CHARACTERGUID)_Character, _Instance)
AND
DB_LLINNATE_Skills_Replacers(_ReplacerFlag, _RacialSkillResult, _OriginSkillResult)
THEN
ObjectClearFlag(_Character, _ReplacerFlag);
LLINNATE_ReplaceRacialSkill(_Character, _RacialSkillResult);
LLINNATE_ReplaceOriginSkill(_Character, _OriginSkillResult);
ObjectSetFlag(_Character, "LLINNATE_CanReverseSkillReplacer");

PROC
LLINNATE_RemoveReplacedRacialSkill((CHARACTERGUID)_Character)
AND
GetVarString(_Character, "LLINNATE_NewRacialSkill", _Skill)
AND
_Skill != ""
THEN
CharacterRemoveSkill(_Character, _Skill);
SetVarString(_Character, "LLINNATE_NewRacialSkill", "");

PROC
LLINNATE_ReplaceRacialSkill((CHARACTERGUID)_Character, (STRING)_NewSkill)
AND
_NewSkill != ""
AND
DB_LLINNATE_Skills_Race(_Tag, _Skill)
AND
_Skill != _NewSkill
AND
IsTagged(_Character, _Tag, 1)

THEN
CharacterRemoveSkill(_Character, _Skill);

PROC
LLINNATE_ReplaceRacialSkill((CHARACTERGUID)_Character, (STRING)_NewSkill)
AND
_NewSkill != ""
THEN
LLINNATE_RemoveReplacedRacialSkill(_Character);
CharacterAddSkill(_Character, _NewSkill);
SetVarString(_Character, "LLINNATE_NewRacialSkill", _NewSkill);

PROC
LLINNATE_RemoveReplacedOriginSkill((CHARACTERGUID)_Character)
AND
GetVarString(_Character, "LLINNATE_NewOriginSkill", _Skill)
AND
_Skill != ""
THEN
CharacterRemoveSkill(_Character, _Skill);
SetVarString(_Character, "LLINNATE_NewOriginSkill", "");

PROC
LLINNATE_ReplaceOriginSkill((CHARACTERGUID)_Character, (STRING)_NewSkill)
AND
_NewSkill != ""
AND
DB_LLINNATE_Skills_Origins(_Tag, _Skill)
AND
IsTagged(_Character, _Tag, 1)
THEN
CharacterRemoveSkill(_Character, _Skill);

PROC
LLINNATE_ReplaceOriginSkill((CHARACTERGUID)_Character, (STRING)_NewSkill)
AND
_NewSkill != ""
THEN
LLINNATE_RemoveReplacedOriginSkill(_Character);
CharacterAddSkill(_Character, _NewSkill);
SetVarString(_Character, "LLINNATE_NewOriginSkill", _NewSkill);

IF
ObjectFlagSet("LLINNATE_Commands_ReverseSkillReplacer", (CHARACTERGUID)_Character, _Instance)
THEN
ObjectClearFlag(_Character, "LLINNATE_Commands_ReverseSkillReplacer");
LLINNATE_RemoveReplacedRacialSkill(_Character);
LLINNATE_RemoveReplacedOriginSkill(_Character);
LLINNATE_RevertReplacedSkills(_Character);

PROC
LLINNATE_RevertReplacedSkills((CHARACTERGUID)_Character)
AND
DB_LLINNATE_Skills_Race(_Tag, _Skill)
AND
IsTagged(_Character, _Tag, 1)
THEN
CharacterAddSkill(_Character, _Skill);

PROC
LLINNATE_RevertReplacedSkills((CHARACTERGUID)_Character)
AND
DB_LLINNATE_Skills_Origins(_Tag, _Skill)
AND
IsTagged(_Character, _Tag, 1)
THEN
CharacterAddSkill(_Character, _Skill);

IF
TextEventSet("llinnate_settings")
AND
CharacterGetHostCharacter(_Host)
AND
QRY_SpeakerIsAvailable(_Host)
THEN
Proc_StartDialog(0, "LLINNATE_SettingsMenu", _Host, _Host);
//END_REGION

//REGION VERSIONING
IF
GameStarted(_Level, _)
AND
IsGameLevel(_Level, 1)
AND
LLINNATE_Updater_QRY_UpdateNeeded("1.0.1.0")
THEN
LLINNATE_Internal_RegisterMod();

PROC
LLINNATE_Internal_RegisterMod()
THEN
LLINNATE_Updater_RemoveOldVersions("1.0.1.0");
LLINNATE_Updater_SetVersion("1.0.1.0");

QRY
LLINNATE_Updater_QRY_UpdateNeeded((STRING)_Version)
AND
NOT DB_Mods_Registered("InnateTalents", "LaughingLeader", _Version)
THEN
DB_NOOP(1);

PROC
LLINNATE_Updater_RemoveOldVersions((STRING)_NextVersion)
AND
DB_Mods_Registered("InnateTalents", "LaughingLeader", _Version)
THEN
NOT DB_Mods_Registered("InnateTalents", "LaughingLeader", _Version);
LLINNATE_Updater_VersionUpdated(_Version, _NextVersion);

PROC
LLINNATE_Updater_VersionUpdated((STRING)_Version, (STRING)_NextVersion)
THEN
DB_NOOP(1);

PROC
LLINNATE_Updater_SetVersion((STRING)_Version)
AND
GlobalGetFlag("LeaderLib_Initialized", 1)
THEN
//Fire LeaderLib ModUpdated procs.
DB_LeaderLib_ModApi_RegisterMod("InnateTalents", "LaughingLeader", _Version);

PROC
LLINNATE_Updater_SetVersion((STRING)_Version)
AND
NOT GlobalGetFlag("LeaderLib_Initialized", 1)
THEN
DB_Mods_Registered("InnateTalents", "LaughingLeader", _Version);
//END_REGION

//REGION LEADERLIB
IF
StoryEvent(_, "LeaderLib_Initialized")
AND
NOT DB_LLINNATE_RegisteredLeaderLibSettings(_)
THEN
DB_LLINNATE_RegisteredLeaderLibSettings(1);

IF
DB_LLINNATE_RegisteredLeaderLibSettings(1)
THEN
DB_LeaderLib_ModApi_RegisterMenu("LaughingLeader.InnateTalents", "[Innate Talents] Settings", "LLINNATE_SettingsMenu", "InnateTalents", "LaughingLeader");
DB_LeaderLib_ModApi_RegisterActiveGoal("InnateTalents", "LaughingLeader", "LaughingLeader_InnateTalents");

PROC
LLINNATE_Updater_VersionUpdated((STRING)_Version, "1.0.0.3")
THEN
DB_Mods_ActiveGoal("InnateTalents", "LaughingLeader", "LaughingLeader_InnateTalents");
DB_LeaderLib_ModApi_RegisterMenu("LaughingLeader.InnateTalents", "[Innate Talents] Settings", "LLINNATE_SettingsMenu", "InnateTalents", "LaughingLeader");
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "__Start"
